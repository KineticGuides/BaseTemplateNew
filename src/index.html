<!doctype html>
<html lang="en">
<!-- <base href="/app/"> -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Kinetic MD - AI Enabled Health">
  <meta name="author" content="Edward Honour - Kinetic Seas AI (OTC:KSAI)" />
  <link rel="canonical" href="https://www.bootstrap.gallery/">
  <meta property="og:url" content="https://www.bootstrap.gallery">
  <meta property="og:title" content="Kinetic MD - AI Enabled Health">
  <meta property="og:description" content="Marketplace for Bootstrap Admin Dashboards">
  <meta property="og:type" content="Website">
  <meta property="og:site_name" content="Bootstrap Gallery">
  <link rel="shortcut icon" href="assets/images/favicon.svg">
  <title>Bootstrap Admin Dashboards</title>
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/fonts/bootstrap/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/vendor/overlay-scroll/OverlayScrollbars.min.css">
</head>
<body>
  <app-root>
    <!-- app.component.html is injected here -->
  </app-root>
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/modernizr.js"></script>
  <script src="assets/js/moment.js"></script>
  <script src="assets/vendor/overlay-scroll/jquery.overlayScrollbars.min.js"></script>
  <script src="assets/vendor/overlay-scroll/custom-scrollbar.js"></script>
  <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    let device;
  
    // Request permission to access the microphone
    async function getMediaPermissions() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log('Microphone access granted.');
        return stream;
      } catch (err) {
        console.error('Microphone access denied: ', err);
        throw new Error('Microphone permission is required.');
      }
    }
  
    // Function to fetch the token from your PHP server
    async function fetchToken(userId) {
      const response = await fetch('https://sqllabs.ai/api/cat.php',{
                  method: 'post',
                  headers:new Headers({
                      'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8'
                  }),
                  body: 'login=' + userId
            });
    const data = await response.json();
    return data.token;
  }

  // Initialize Twilio Client with the token and media permissions
  async function initializeTwilioClient() {
    try {
      const mediaStream = await getMediaPermissions(); // Request microphone access
      //userId = document.getElementById('userId').innerHTML;
      userId="Joe";
      const token = await fetchToken(userId);
  console.log(token)
      // Create a new Twilio Device instance
      device = new Twilio.Device(token, {
        codecPreferences: ['opus', 'pcmu'],
        debug: true,
        // Pass the mediaStream (microphone access) to Twilio
        audioHelper: { inputStream: mediaStream }
      });

      device.on('ready', (device) => {
        console.log('Twilio Device is ready to make/receive calls');
      });

      device.on('incoming', (connection) => {
        console.log('Incoming call from:', connection.parameters.From);
        incomingConnection = connection;
        showIncomingCallUI();
        
                connection.on('disconnect', () => {
                console.log('Call disconnected before answering');
                hideIncomingCallUI(); // Hide the UI when the call is disconnected
                });

    });


      device.on('cancel', () => {
        console.log('Call disconnected before answering');
        hideIncomingCallUI(); // Hide the UI when the call is disconnected
      });
      device.on('error', (error) => {
        console.error('Twilio Device error: ', error);
      });
    } catch (error) {
      console.error('Error initializing Twilio Client:', error);
    }
  }

  // Initialize Twilio when the page loads
  window.onload = function() {
    //initializeTwilioClient();
  };

  function login() {
     initializeTwilioClient();
     userId = document.getElementById('userId').innerHTML;
     //document.getElementById("loginstatus").innerHTML = "Logged in as : " + userId;
  }

  function logout() {
        if (device) {
        device.destroy();  // This will stop incoming calls and disconnect everything
        console.log('Twilio Device destroyed, no longer listening for calls');
        } else {
        console.error('Twilio device is not initialized.');
        }
        document.getElementById("loginstatus").innerHTML = "Logged out";;
  }

  function showIncomingCallUI() {
    document.getElementById('incoming-call').style.display = 'block'; // Show answer/reject buttons
  }

  // Hide incoming call UI
  function hideIncomingCallUI() {
    document.getElementById('incoming-call').style.display = 'none';
  }

  function answerCall() {
    if (incomingConnection) {
      incomingConnection.accept();
      console.log('Call answered');
      hideIncomingCallUI();
    }
  }

 function rejectCall() {
    if (incomingConnection) {
      incomingConnection.reject();
      console.log('Call rejected');
      hideIncomingCallUI();
    }
  }


  // Function to make an outgoing call
  function makeCall() {
    phone = document.getElementById('outphone').value;
    const params = { To: phone }; // Specify the recipient
    device.connect(params);
  }

  // Function to hang up the call
  function hangUpCall() {
    if (device) {
      device.disconnectAll();
    }
  }
</script>
</body>
</html>